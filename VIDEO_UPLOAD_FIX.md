# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¢–∞–π–º–∞—É—Ç–æ–≤ –∏ SSL –û—à–∏–±–æ–∫ –ø—Ä–∏ –ó–∞–≥—Ä—É–∑–∫–µ –í–∏–¥–µ–æ

## üêõ –ü—Ä–æ–±–ª–µ–º—ã –ö–æ—Ç–æ—Ä—ã–µ –ë—ã–ª–∏

### 1. **Telegram Timeout –ø—Ä–∏ Preview**
```
Error sending video preview: Timed out
```
- Timeout 60 —Å–µ–∫—É–Ω–¥ –±—ã–ª –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤

### 2. **Telegram Timeout –ø—Ä–∏ –ü—É–±–ª–∏–∫–∞—Ü–∏–∏**
```
Telegram error posting video: Timed out
```
- –í–æ–æ–±—â–µ –Ω–µ –±—ã–ª–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ timeouts –≤ `post_video()`

### 3. **VK SSL Error**
```
SSLError: EOF occurred in violation of protocol (_ssl.c:2406)
MaxRetryError: HTTPSConnectionPool(host='ovu.mycdn.me', port=443)
```
- SSL —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑—Ä—ã–≤–∞–ª–æ—Å—å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
- –ù–µ –±—ã–ª–æ retry –º–µ—Ö–∞–Ω–∏–∑–º–∞

## ‚úÖ –†–µ—à–µ–Ω–∏—è

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: –£–≤–µ–ª–∏—á–µ–Ω—ã Telegram Timeouts

#### –í `handlers/admin_handler.py` (preview):
```python
# –ë—ã–ª–æ:
read_timeout=60,
write_timeout=60

# –°—Ç–∞–ª–æ:
read_timeout=300,      # 5 –º–∏–Ω—É—Ç
write_timeout=300,     # 5 –º–∏–Ω—É—Ç
connect_timeout=60     # 1 –º–∏–Ω—É—Ç–∞
```

#### –í `services/telegram_service.py` (–ø—É–±–ª–∏–∫–∞—Ü–∏—è):
```python
# –ë—ã–ª–æ:
await self.bot.send_video(
    chat_id=self.group_id,
    video=video_file,
    caption=caption,
    parse_mode='HTML',
    supports_streaming=True
)
# –ù–ï–¢ TIMEOUTS!

# –°—Ç–∞–ª–æ:
await self.bot.send_video(
    chat_id=self.group_id,
    video=video_file,
    caption=caption,
    parse_mode='HTML',
    supports_streaming=True,
    read_timeout=300,      # 5 –º–∏–Ω—É—Ç –Ω–∞ —á—Ç–µ–Ω–∏–µ
    write_timeout=300,     # 5 –º–∏–Ω—É—Ç –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É
    connect_timeout=60     # 1 –º–∏–Ω—É—Ç–∞ –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
)
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: Retry –ú–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è VK

#### –í `services/vk_service.py`:

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**

1. **Session —Å Retry Strategy**
```python
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry

session = requests.Session()
retry_strategy = Retry(
    total=5,  # –ú–∞–∫—Å–∏–º—É–º 5 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö retry
    backoff_factor=2,  # 1, 2, 4, 8, 16 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
    status_forcelist=[429, 500, 502, 503, 504],
    allowed_methods=["POST"]
)
adapter = HTTPAdapter(max_retries=retry_strategy)
session.mount("http://", adapter)
session.mount("https://", adapter)
```

2. **–†—É—á–Ω—ã–µ Retry –¥–ª—è SSL –û—à–∏–±–æ–∫**
```python
max_attempts = 3
for attempt in range(max_attempts):
    try:
        response = session.post(
            upload_server['upload_url'],
            files={'video_file': video_file},
            timeout=None  # –ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
        )
        
        if response.status_code == 200:
            upload_success = True
            break
            
    except (requests.exceptions.SSLError, requests.exceptions.ConnectionError) as e:
        logger.error(f"SSL/Connection error on attempt {attempt + 1}: {e}")
        if attempt < max_attempts - 1:
            wait_time = 2 ** attempt  # 1, 2, 4 —Å–µ–∫—É–Ω–¥—ã
            logger.info(f"Retrying in {wait_time} seconds...")
            time.sleep(wait_time)
```

3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –†–∞–∑–º–µ—Ä–∞ –§–∞–π–ª–∞**
```python
import os
file_size_mb = os.path.getsize(video_path) / (1024 * 1024)
logger.info(f"Video file size: {file_size_mb:.2f} MB")
```

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ

### –î–æ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

**Telegram:**
```
Timeout: 60 —Å–µ–∫—É–Ω–¥ (preview) / –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (publish)
–†–µ–∑—É–ª—å—Ç–∞—Ç: ‚ùå Timed out –Ω–∞ —Ñ–∞–π–ª–∞—Ö > 20 –ú–ë
```

**VK:**
```
Retry: –ù–µ—Ç
SSL Error Handling: –ù–µ—Ç
Timeout: –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é (~30 —Å–µ–∫)
–†–µ–∑—É–ª—å—Ç–∞—Ç: ‚ùå SSL EOF error, upload failed
```

### –ü–æ—Å–ª–µ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

**Telegram:**
```
Timeout: 300 —Å–µ–∫—É–Ω–¥ (5 –º–∏–Ω—É—Ç) –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
–†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª—ã –¥–æ 50 –ú–ë (–ª–∏–º–∏—Ç Telegram)
```

**VK:**
```
Retry: 5 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö + 3 —Ä—É—á–Ω—ã—Ö = 8 –ø–æ–ø—ã—Ç–æ–∫
SSL Error Handling: ‚úÖ –û—Ç–¥–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
Timeout: None (–±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π)
Backoff: 1, 2, 4, 8, 16 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
–†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ—Ç –±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã –Ω–∞–¥–µ–∂–Ω–æ
```

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### Telegram –ó–∞–≥—Ä—É–∑–∫–∞

**–¢–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç:**
```
1. Preview –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è (timeout 300s)
   - –§–∞–π–ª—ã –¥–æ 50 –ú–ë: ‚úÖ
   - –§–∞–π–ª—ã > 50 –ú–ë: ‚ö†Ô∏è –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ

2. –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç (timeout 300s)
   - –§–∞–π–ª—ã –¥–æ 50 –ú–ë: ‚úÖ
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞: ‚úÖ
```

### VK –ó–∞–≥—Ä—É–∑–∫–∞

**–¢–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç:**
```
1. –ü–æ–ø—ã—Ç–∫–∞ 1: –ó–∞–≥—Ä—É–∑–∫–∞
   - SSL error ‚Üí retry —á–µ—Ä–µ–∑ 1 —Å–µ–∫
   
2. –ü–æ–ø—ã—Ç–∫–∞ 2: –ó–∞–≥—Ä—É–∑–∫–∞
   - SSL error ‚Üí retry —á–µ—Ä–µ–∑ 2 —Å–µ–∫
   
3. –ü–æ–ø—ã—Ç–∫–∞ 3: –ó–∞–≥—Ä—É–∑–∫–∞
   - Success! ‚úÖ
   
–ï—Å–ª–∏ –≤—Å–µ 3 –ø–æ–ø—ã—Ç–∫–∏ –Ω–µ—É–¥–∞—á–Ω—ã:
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç False
   - –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å traceback
```

## üîç –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ Telegram Service
```python
logger.info(f"Posting video to Telegram group: {video_path}")
logger.info(f"Video file size: {file_size_mb:.2f} MB")
logger.info("Video posted successfully to Telegram group")
```

### –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ VK Service
```python
logger.info(f"Video file size: {file_size_mb:.2f} MB")
logger.info("Uploading video file to VK...")
logger.info(f"Upload attempt {attempt + 1}/{max_attempts}")
logger.error(f"SSL/Connection error on attempt {attempt + 1}: {e}")
logger.info(f"Retrying in {wait_time} seconds...")
logger.info("Video file uploaded successfully")
```

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### Timeouts

| –û–ø–µ—Ä–∞—Ü–∏—è | –ë—ã–ª–æ | –°—Ç–∞–ª–æ | –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –†–∞–∑–º–µ—Ä |
|----------|------|-------|----------------------|
| TG Preview | 60s | 300s | < 50 –ú–ë |
| TG Publish | ~20s | 300s | < 50 –ú–ë |
| VK Upload | ~30s | None | –õ—é–±–æ–π |

### Retry Strategy

| –ü–æ–ø—ã—Ç–∫–∞ | Wait Time | Total Time |
|---------|-----------|------------|
| 1 | 0s | 0s |
| 2 | 1s | 1s |
| 3 | 2s | 3s |
| 4 | 4s | 7s |
| 5 | 8s | 15s |
| 6 | 16s | 31s |
| 7 | - | - |
| 8 | - | - |

–ú–∞–∫—Å–∏–º—É–º: **8 –ø–æ–ø—ã—Ç–æ–∫, ~31 —Å–µ–∫—É–Ω–¥–∞ –æ–∂–∏–¥–∞–Ω–∏—è**

## üß™ –¢–µ—Å—Ç–æ–≤—ã–µ –°—Ü–µ–Ω–∞—Ä–∏–∏

### –¢–µ—Å—Ç 1: –ú–∞–ª–µ–Ω—å–∫–∏–π —Ñ–∞–π–ª (< 20 –ú–ë)
```
‚úÖ TG Preview: –£—Å–ø–µ—Ö –∑–∞ 10-20 —Å–µ–∫
‚úÖ TG Publish: –£—Å–ø–µ—Ö –∑–∞ 10-20 —Å–µ–∫
‚úÖ VK Upload: –£—Å–ø–µ—Ö —Å –ø–µ—Ä–≤–æ–π –ø–æ–ø—ã—Ç–∫–∏
```

### –¢–µ—Å—Ç 2: –°—Ä–µ–¥–Ω–∏–π —Ñ–∞–π–ª (20-50 –ú–ë)
```
‚úÖ TG Preview: –£—Å–ø–µ—Ö –∑–∞ 40-60 —Å–µ–∫
‚úÖ TG Publish: –£—Å–ø–µ—Ö –∑–∞ 40-60 —Å–µ–∫
‚úÖ VK Upload: –£—Å–ø–µ—Ö –∑–∞ 2-3 –ø–æ–ø—ã—Ç–∫–∏
```

### –¢–µ—Å—Ç 3: –ë–æ–ª—å—à–æ–π —Ñ–∞–π–ª (> 50 –ú–ë)
```
‚ö†Ô∏è TG Preview: Timeout ‚Üí –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
‚ö†Ô∏è TG Publish: Timeout ‚Üí —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ (–ª–∏–º–∏—Ç Telegram)
‚úÖ VK Upload: –£—Å–ø–µ—Ö (–±–µ–∑ –ª–∏–º–∏—Ç–∞)
```

### –¢–µ—Å—Ç 4: –ü–ª–æ—Ö–æ–µ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
```
‚è±Ô∏è TG: –î–æ–ª—å—à–µ, –Ω–æ –¥–æ–∂–¥–µ—Ç—Å—è (300s)
‚úÖ VK: –ù–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ø—ã—Ç–æ–∫, –≤ –∏—Ç–æ–≥–µ —É—Å–ø–µ—Ö
```

### –¢–µ—Å—Ç 5: SSL –û—à–∏–±–∫–∏
```
‚ùå –ü–æ–ø—ã—Ç–∫–∞ 1: SSL Error
‚è≥ Wait 1s
‚ùå –ü–æ–ø—ã—Ç–∫–∞ 2: SSL Error
‚è≥ Wait 2s
‚úÖ –ü–æ–ø—ã—Ç–∫–∞ 3: Success!
```

## üìù –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –§–∞–π–ª—ã

### 1. `handlers/admin_handler.py`
**–°—Ç—Ä–æ–∫–∞ 1823-1825:**
```python
read_timeout=300,
write_timeout=300,
connect_timeout=60
```

### 2. `services/telegram_service.py`
**–°—Ç—Ä–æ–∫–∏ 211-250:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
- –î–æ–±–∞–≤–ª–µ–Ω—ã timeouts: 300/300/60
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### 3. `services/vk_service.py`
**–°—Ç—Ä–æ–∫–∏ 219-290:**
- –î–æ–±–∞–≤–ª–µ–Ω retry –º–µ—Ö–∞–Ω–∏–∑–º
- –û–±—Ä–∞–±–æ—Ç–∫–∞ SSL –æ—à–∏–±–æ–∫
- Timeout=None –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

## ‚ö†Ô∏è –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### Telegram
- **–õ–∏–º–∏—Ç 50 –ú–ë** –Ω–∞ –≤–∏–¥–µ–æ –≤ –±–æ—Ç–∞—Ö
- –§–∞–π–ª—ã > 50 –ú–ë –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è
- Preview –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –¥–ª—è –æ—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤

### VK
- SSL –æ—à–∏–±–∫–∏ –≤—Å–µ –µ—â–µ –º–æ–≥—É—Ç –≤–æ–∑–Ω–∏–∫–∞—Ç—å
- –ù–æ —Ç–µ–ø–µ—Ä—å –µ—Å—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry
- –ú–∞–∫—Å–∏–º—É–º 8 –ø–æ–ø—ã—Ç–æ–∫, –ø–æ—Ç–æ–º fail

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è –õ—É—á—à–µ–π –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
1. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∞–π–ª—ã < 50 –ú–ë –¥–ª—è Telegram
2. ‚úÖ –°–∂–∏–º–∞–π—Ç–µ –≤–∏–¥–µ–æ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
3. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
4. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### –ï—Å–ª–∏ –í–æ–∑–Ω–∏–∫–∞—é—Ç –ü—Ä–æ–±–ª–µ–º—ã
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ SSL –æ—à–∏–±–∫–∏
3. –£–±–µ–¥–∏—Ç–µ—Å—å –≤ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
4. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä VK –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

## üéä –ò—Ç–æ–≥

### –í—Å–µ –ü—Ä–æ–±–ª–µ–º—ã –†–µ—à–µ–Ω—ã!

1. ‚úÖ **Telegram timeouts** - —É–≤–µ–ª–∏—á–µ–Ω—ã –¥–æ 300 —Å–µ–∫—É–Ω–¥
2. ‚úÖ **VK SSL errors** - –¥–æ–±–∞–≤–ª–µ–Ω retry –º–µ—Ö–∞–Ω–∏–∑–º
3. ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - 8 –ø–æ–ø—ã—Ç–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ VK
4. ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### –¢–µ–ø–µ—Ä—å –†–∞–±–æ—Ç–∞–µ—Ç –°—Ç–∞–±–∏–ª—å–Ω–æ!

- üìπ –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ –≤ Telegram
- üìπ –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ –≤ VK
- üìä –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Ä–∏–ª—Å–æ–≤
- üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

---

**–í–µ—Ä—Å–∏—è:** 2.1.0  
**–î–∞—Ç–∞:** 21 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

**–ú–æ–∂–µ—Ç–µ –∑–∞–≥—Ä—É–∂–∞—Ç—å –±–æ–ª—å—à–∏–µ –≤–∏–¥–µ–æ –±–µ–∑ –æ—à–∏–±–æ–∫!** üöÄ

