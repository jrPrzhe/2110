# 🔄 Диаграмма Состояний Бота

## 📊 Машина Состояний

Бот работает по принципу **машины конечных состояний (FSM)**.  
Каждый пользователь может находиться только в одном состоянии одновременно.

---

## 🗺️ Визуальная Диаграмма

```
                        ┌─────────┐
                        │  START  │
                        │ /start  │
                        └────┬────┘
                             │
                             ▼
                ┌────────────────────────┐
                │  PLATFORM_SELECTION    │
                │  Выбор платформы       │
                └────────────┬───────────┘
                             │
                ┌────────────┴────────────┬──────────────┐
                │                         │              │
                ▼                         ▼              ▼
        ┌───────────────┐         ┌──────────┐    ┌──────────┐
        │   INSTAGRAM   │         │ TELEGRAM │    │    VK    │
        │   ARTICLE     │         │    или   │    │    или   │
        │   CHECK       │         │   BOTH   │    │   ALL    │
        └───────┬───────┘         └────┬─────┘    └────┬─────┘
                │                      │               │
                ▼                      │               │
        ┌───────────────┐              │               │
        │ ARTICLE_CHECK │              │               │
        │  Да / Нет     │              │               │
        └───────┬───────┘              │               │
                │                      │               │
                └──────────────────────┴───────────────┘
                             │
                             ▼
                  ┌──────────────────┐
                  │  CONTENT_INPUT   │
                  │ Ожидание контента│
                  └─────────┬────────┘
                            │
          ┌─────────────────┼─────────────────┐
          │                 │                 │
          ▼                 ▼                 ▼
    ┌──────────┐      ┌──────────┐     ┌──────────┐
    │  ФОТО    │      │  ВИДЕО   │     │  ССЫЛКА  │
    │  1-10    │      │   FILE   │     │  REELS   │
    └────┬─────┘      └────┬─────┘     └────┬─────┘
         │                 │                 │
         │                 │                 ▼
         │                 │         ┌───────────────┐
         │                 │         │ REELS_DOWNLOAD│
         │                 │         │ Скачивание... │
         │                 │         └───────┬───────┘
         │                 │                 │
         │                 ▼                 │
         │         ┌───────────────┐         │
         │         │ REELS_WAITING │         │
         │         │   _CAPTION    │◄────────┘
         │         └───────┬───────┘
         │                 │
         └─────────────────┴─────────────────┐
                           │                 │
                           ▼                 │
                  ┌─────────────────┐        │
                  │ WAITING_CAPTION │◄───────┘
                  │ Ввод подписи    │
                  └────────┬────────┘
                           │
                           ▼
                  ┌─────────────────┐
                  │ CAPTION_ENTERED │
                  │ Подпись введена │
                  └────────┬────────┘
                           │
          ┌────────────────┼────────────────┬───────────┐
          │                │                │           │
          ▼                ▼                ▼           ▼
    ┌──────────┐     ┌──────────┐    ┌──────────┐  ┌──────┐
    │ PUBLISH  │     │ SCHEDULE │    │    AI    │  │CANCEL│
    │   NOW    │     │   POST   │    │   HELP   │  │      │
    └────┬─────┘     └────┬─────┘    └────┬─────┘  └──┬───┘
         │                │                │           │
         │                ▼                │           │
         │         ┌────────────┐          │           │
         │         │  SCHEDULED │          │           │
         │         │ Запланирован          │           │
         │         └────┬───────┘          │           │
         │              │                  │           │
         │              │ [В указанное     │           │
         │              │  время]          │           │
         │              │                  │           │
         └──────────────┴──────────────────┴───────────┘
                           │
                           ▼
                  ┌─────────────────┐
                  │   PUBLISHING    │
                  │  Публикация...  │
                  └────────┬────────┘
                           │
          ┌────────────────┼────────────────┐
          │                │                │
          ▼                ▼                ▼
    ┌──────────┐     ┌──────────┐    ┌──────────┐
    │INSTAGRAM │     │ TELEGRAM │    │    VK    │
    │ SUCCESS  │     │ SUCCESS  │    │ SUCCESS  │
    └────┬─────┘     └────┬─────┘    └────┬─────┘
         │                │                │
         └────────────────┴────────────────┘
                           │
                           ▼
                  ┌─────────────────┐
                  │    CLEANUP      │
                  │ Удаление файлов │
                  └────────┬────────┘
                           │
                           ▼
                  ┌─────────────────┐
                  │      DONE       │
                  │  ✅ Готово!     │
                  └─────────────────┘
```

---

## 📝 Описание Состояний

### 1. START
**Начальное состояние**
- Команда: `/start`
- Действие: Показать главное меню
- Переход: → PLATFORM_SELECTION (при нажатии "🚀 Начать публикацию")

### 2. PLATFORM_SELECTION
**Выбор платформы для публикации**
- Варианты: Instagram, Telegram, VK, Все платформы
- Переход: 
  - Instagram → ARTICLE_CHECK_SELECTION
  - Telegram/VK/All → CONTENT_INPUT

### 3. ARTICLE_CHECK_SELECTION
**Выбор проверки артикулов** (только для Instagram/Telegram/VK)
- Варианты: Да / Нет
- Переход: → CONTENT_INPUT

### 4. CONTENT_INPUT
**Ожидание контента от пользователя**
- Принимает:
  - Фото (1-10 шт) → PHOTOS_UPLOAD
  - Видео файл → REELS_WAITING_CAPTION
  - Ссылку на Instagram → REELS_URL_INPUT
- Переход: Зависит от типа контента

### 5. PHOTOS_UPLOAD
**Загрузка фотографий**
- Собирает фото (до 10)
- Ожидает: Больше фото или подпись
- Переход: → WAITING_CAPTION (когда пользователь отправляет текст)

### 6. REELS_URL_INPUT
**Ожидание ссылки на рилс**
- Принимает: URL формата `instagram.com/reel/...`
- Переход: → REELS_DOWNLOAD

### 7. REELS_DOWNLOAD
**Скачивание видео из Instagram**
- Показывает прогресс (0-100%)
- Кнопка отмены доступна
- Переход: → REELS_WAITING_CAPTION

### 8. REELS_WAITING_CAPTION
**Ожидание подписи для видео**
- Принимает: Текст подписи
- Переход: → CAPTION_ENTERED

### 9. WAITING_CAPTION
**Ожидание подписи для фото**
- Принимает: Текст подписи
- Проверяет артикулы (если включено)
- Переход: → CAPTION_ENTERED

### 10. CAPTION_ENTERED
**Подпись введена, предпросмотр**
- Показывает: Предпросмотр поста
- Варианты:
  - ⚡ Опубликовать сейчас → PUBLISHING
  - ⏰ Запланировать → TIME_INPUT
  - 🤖 Помощь ИИ → AI_PROCESSING
- Переход: Зависит от выбора

### 11. TIME_INPUT
**Ввод времени для планирования**
- Принимает: "15:30", "завтра 10:00", "2024-01-15 14:00"
- Переход: → SCHEDULED

### 12. SCHEDULED
**Пост запланирован**
- Создаёт задачу в планировщике
- Ожидает: Указанное время
- Переход: → PUBLISHING (автоматически в назначенное время)

### 13. AI_PROCESSING
**Обработка подписи через AI**
- Отправляет запрос в Google AI
- Получает улучшенную подпись
- Переход: → CAPTION_ENTERED (с новой подписью)

### 14. PUBLISHING
**Процесс публикации**
- Обрабатывает фото (ресайз, формат)
- Публикует на выбранные платформы
- Показывает прогресс
- Переход: → CLEANUP

### 15. CLEANUP
**Очистка временных файлов**
- Удаляет загруженные фото/видео
- Очищает состояние пользователя
- Переход: → DONE

### 16. DONE
**Завершение**
- Показывает результат
- Возврат в главное меню
- Переход: → START

---

## ⚡ Специальные Переходы

### Отмена (/cancel)
```
Любое состояние → CLEANUP → DONE → START
```

### Ошибка
```
Любое состояние → ERROR → CLEANUP → DONE → START
```

### Таймаут
```
Состояние без активности > 1 час → AUTO_CLEANUP → START
```

---

## 🎯 Типы Контента и Их Пути

### Путь 1: Фото-пост
```
START → PLATFORM → ARTICLE_CHECK → PHOTO_INPUT → CAPTION → PUBLISH → DONE
```

### Путь 2: Видео-пост
```
START → PLATFORM → VIDEO_INPUT → CAPTION → PUBLISH → DONE
```

### Путь 3: Рилс из Instagram
```
START → PLATFORM → URL_INPUT → DOWNLOAD → CAPTION → PUBLISH → DONE
```

### Путь 4: Запланированный пост
```
START → PLATFORM → CONTENT → CAPTION → TIME_INPUT → SCHEDULED → [ожидание] → PUBLISH → DONE
```

---

## 🔐 Контроль Состояний

### Хранение состояния
```python
user_states = {
    user_id: {
        'step': 'current_state',
        'post_mode': 'auto|single|multi|reels|video',
        'target_platform': 'instagram|telegram|vk|both|all',
        'photos': [],
        'caption': '',
        'check_articles': True/False,
        'article_numbers': [],
        'reels_url': '',
        'reels_video_path': '',
        'scheduled_time': None,
        'cancelled': False
    }
}
```

### Очистка состояния
- После успешной публикации
- При отмене (/cancel)
- При ошибке
- При таймауте (автоматически)

---

## 🚦 Валидация Переходов

Бот проверяет корректность переходов:

```python
# Пример: нельзя отправить подпись без фото
if state['step'] != 'waiting_caption':
    return error("Сначала отправьте фото")

# Пример: нельзя опубликовать без подписи
if state['step'] != 'caption_entered':
    return error("Сначала введите подпись")
```

---

## 🛡️ Защита от Ошибок

### Try-Catch блоки
Каждое состояние обработано try-catch для предотвращения сбоев

### Откат состояния
При ошибке состояние откатывается к безопасному (START)

### Логирование
Все переходы логируются для отладки

---

## 📖 Для Разработчиков

### Добавление нового состояния

1. Добавьте состояние в `user_states`
2. Создайте обработчик `handle_new_state()`
3. Добавьте переходы в/из состояния
4. Обновите валидацию
5. Обновите эту диаграмму

### Пример кода состояния
```python
async def handle_new_state(self, update, context):
    user_state = self.get_user_state(update.effective_user.id)
    
    # Проверка текущего состояния
    if user_state['step'] != 'previous_state':
        await update.message.reply_text("❌ Неверный шаг")
        return
    
    # Логика состояния
    # ...
    
    # Переход к следующему состоянию
    user_state['step'] = 'next_state'
    await update.message.reply_text("✅ Готово")
```

---

**Версия:** 1.0  
**Последнее обновление:** Октябрь 2024

